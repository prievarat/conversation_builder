<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conversation Builder – Beágyazott DB • Free Navigation</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Nunito:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --primary-500:#F4A329; --primary-700:#B45309;
    --secondary-500:#2BB6B4; --secondary-700:#0F766E;
    --bg:#FFF7F2; --surface:#FFFFFF; --surface-alt:#F5F7FA; --border:#E6E9EF;
    --text:#1F2937; --text-2:#4B5563; --muted:#6B7280; --inv:#fff;
    --shadow:0 4px 14px rgba(17,24,39,0.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font:16px/1.5 "Inter","Nunito",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(255,247,242,.95), rgba(255,247,242,.85));
         border-bottom:1px solid var(--border);backdrop-filter:saturate(1.05) blur(6px)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:28px;margin:0 0 8px;font-weight:600}
  .toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
  select,button,input[type="file"]{
    background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  button{cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--primary-700),var(--primary-500));color:var(--inv);border:0;font-weight:600}
  /* no not-allowed cursor; just fade */
  button:disabled{opacity:.55}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9999px;background:var(--surface-alt);
        border:1px solid var(--border);color:var(--muted);font-size:12px}
  .pill.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#2F9E44}
  .pill.warn{background:rgba(245,159,0,.12);border-color:rgba(245,159,0,.35);color:#B45309}
  .pill.bad{background:rgba(217,45,32,.12);border-color:rgba(217,45,32,.35);color:#D92D20}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .tab{padding:10px 12px;border-radius:12px;background:var(--surface);border:1px solid var(--border);cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#fff,#fbfbfd)}
  main .panel{padding:16px}
  .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;margin:16px 0;box-shadow:var(--shadow)}
  .muted{color:var(--muted)}
  .twocol{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:800px){.twocol{grid-template-columns:1fr}}
  /* quote-style preview */
  .quote{
    padding:12px 14px;border:1px solid var(--border);border-left:5px solid var(--secondary-500);
    border-radius:12px;background:var(--surface-alt);color:var(--text-2)
  }
  /* options */
  .opt{padding:12px;border-radius:12px;background:var(--surface-alt);border:1px solid var(--border);cursor:pointer}
  .opt:hover{box-shadow:0 0 0 3px rgba(43,182,180,.2)}
  .opt.correct{background:rgba(34,197,94,.10);border-color:rgba(34,197,94,.45)}
  .opt.wrong{background:rgba(217,45,32,.08);border-color:rgba(217,45,32,.40)}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .feedback{margin-top:6px;min-height:24px}
  .progress{height:10px;background:var(--surface-alt);border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,var(--secondary-700),var(--secondary-500));width:0%}
  /* Cloze */
  .cloze-line{margin:10px 0;padding:10px;background:var(--surface-alt);border:1px dashed var(--border);border-radius:12px}
  input.blank{display:inline-block;min-width:72px;border:1px solid var(--border);border-radius:8px;padding:3px 6px;background:#fff;color:var(--text);width:92px;max-width:40vw}
  input.blank.correct{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.45)}
  input.blank.wrong{background:rgba(217,45,32,.08);border-color:rgba(217,45,32,.35)}
  /* Order */
  .order-list{display:flex;flex-direction:column;gap:10px}
  .order-item{padding:12px;border-radius:12px;background:var(--surface-alt);border:1px solid var(--border);cursor:grab}
  .order-item.dragging{opacity:.75}
  .role{font-weight:600;margin-right:6px;color:var(--text-2)}
  /* Speak */
  .speak-prompt{font-size:18px;line-height:1.5}
  .speak-solution{margin-top:10px;padding:10px;border-left:4px solid #7EDAD6;background:var(--surface-alt);border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Conversation Builder</h1>
    <div class="toolbar">
      <label class="pill" for="jsonFile">Load JSON</label>
      <input id="jsonFile" type="file" accept="application/json" style="position:absolute;left:-9999px" />
      <span id="dbStatus" class="pill">Beágyazott DB</span>
      <select id="topicSelect" aria-label="Téma kiválasztása"></select>
      <button id="startBtn" class="primary">Start</button>
      <span class="pill" id="scorePill">Pont: 0</span>
      <span class="pill" id="modePill">Mód: —</span>
      <span class="pill" title="Gyorsbillentyűk">1/2/3, Enter • Speak: S</span>
    </div>
    <div class="tabs" role="tablist" aria-label="Módválasztó">
      <div class="tab active" data-tab="build">① Build</div>
      <div class="tab" data-tab="cloze">② Cloze</div>
      <div class="tab" data-tab="order">③ Order</div>
      <div class="tab" data-tab="speak">④ Speak</div>
    </div>
  </div>
</header>

<main class="panel wrap">
  <!-- BUILD -->
  <section id="build" class="card" aria-live="polite">
    <h2>Build – Lépésenkénti összeépítés (MCQ)</h2>
    <div class="card">
      <div class="muted">Előző sor</div>
      <div id="buildPrev" class="quote" style="margin:6px 0 10px"></div>
      <div class="muted">Mi jön most?</div>
      <div id="buildOptions" class="twocol" style="margin-top:8px"></div>
      <div class="actions">
        <button id="buildShow">Show solution</button>
        <button id="buildNext" class="primary" disabled>Tovább</button>
      </div>
      <div id="buildFeedback" class="feedback"></div>
      <div class="progress"><div id="buildProg"></div></div>
    </div>
  </section>

  <!-- CLOZE -->
  <section id="cloze" class="card" hidden>
    <h2>Cloze – Funkciószavak és discourse markerek</h2>
    <div class="row">
      <div class="col">
        <label>Nehézség:
          <select id="clozeLevel">
            <option value="A">A – gyakori funkciószavak</option>
            <option value="AB">A+B – funkció + segédigék/prepozíciók</option>
          </select>
        </label>
      </div>
      <div class="col">
        <div class="pill">Megoldott/Összes: <span id="clozeStats">0/0</span></div>
      </div>
    </div>
    <div id="clozeArea"></div>
    <div class="actions">
      <button id="clozeCheck" class="primary">Ellenőrzés (Enter)</button>
      <button id="clozeHint">Hint (első betű)</button>
      <button id="clozeSolve">Show solution</button>
    </div>
    <div id="clozeFeedback" class="feedback"></div>
  </section>

  <!-- ORDER -->
  <section id="order" class="card" hidden>
    <h2>Order – Sorrendezés (drag&drop)</h2>
    <p class="muted">Húzd a kártyákat helyes sorrendbe, majd kattints az „Ellenőrzés” gombra.</p>
    <div id="orderList" class="order-list" aria-live="polite"></div>
    <div class="actions">
      <button id="orderCheck" class="primary">Ellenőrzés (Enter)</button>
      <button id="orderSolve">Show solution</button>
    </div>
    <div id="orderFeedback" class="feedback"></div>
  </section>

  <!-- SPEAK -->
  <section id="speak" class="card" hidden>
    <h2>Speak – Prompt-alapú beszéd</h2>
    <div class="row">
      <div class="col">
        <label>Szerep:
          <select id="speakRole">
            <option value="B">Diák = B (válaszol B-ként)</option>
            <option value="A">Diák = A</option>
          </select>
        </label>
      </div>
      <div class="col">
        <div class="pill">I said it: <span id="saidCnt">0</span></div>
        <div class="pill">I struggled: <span id="struggledCnt">0</span></div>
        <div class="pill">See solution: <span id="seeCnt">0</span></div>
      </div>
    </div>
    <div class="card">
      <div class="muted">Prompt</div>
      <div id="speakPrompt" class="quote" aria-live="polite"></div>
      <div id="speakSolution" class="speak-solution muted" hidden></div>
      <div class="actions">
        <button id="sSpeak">See solution (S)</button>
        <button id="sSaid" class="pill ok">I said it</button>
        <button id="sStruggled" class="pill warn">I struggled</button>
        <button id="sNext" class="primary">Next (Enter)</button>
      </div>
    </div>
  </section>
</main>

<!-- BEÁGYAZOTT ADATBÁZIS (20 téma) -->
<!-- BEÁGYAZOTT ADATBÁZIS -->
<script id="embedded-db" type="application/json">
{
  "schema_version": 1,
  "meta": {
    "title": "Conversation Builder – Exam-Compatible Dialogues",
    "language": "en",
    "level": "B1–B2",
    "created_at": "2025-10-07",
    "source_note": "Based on Hungarian érettségi-style speaking tasks; adapted for interactive practice.",
    "author": "ChatGPT (with teacher prompts)",
    "license": "For classroom use"
  },
  "topics": [
    {
      "id": "fashion_parties",
      "title": "Fashion & Parties",
      "situation": "Your foreign friend asks for advice about a house party tonight and the opera tomorrow.",
      "functions": ["greeting and topic-setting","asking for clarification","making polite suggestions","giving advice","cultural norms","closing politely"],
      "turns": [
        {"n":1,"speaker":"A","text":"Hey, can I ask for your advice? I’ve got a house party tonight and the opera tomorrow, and honestly, I have no idea what to wear."},
        {"n":2,"speaker":"B","text":"Oh, that’s quite a contrast! Well, for the house party, I’d go with something casual — jeans and a nice shirt. Keep it simple, but clean."},
        {"n":3,"speaker":"A","text":"Right, that makes sense. By the way, should I bring anything for the host, or is that weird?"},
        {"n":4,"speaker":"B","text":"Not weird at all — it’s polite. A small snack or a bottle of soft drink is perfect. Nothing too expensive."},
        {"n":5,"speaker":"A","text":"Okay, thanks. And about behaviour, I don’t want to seem rude or anything."},
        {"n":6,"speaker":"B","text":"No worries — greet the host, be friendly, and thank them before you leave. Also, try not to stay too late unless they say so."},
        {"n":7,"speaker":"A","text":"Got it. Now, the opera is a different story, I guess."},
        {"n":8,"speaker":"B","text":"Yeah, totally. People usually dress more formally there — maybe a dress or a suit. It’s about showing respect for the event."},
        {"n":9,"speaker":"A","text":"I see. Is it okay to take photos during the performance, or is that a big no?"},
        {"n":10,"speaker":"B","text":"Better not — it’s distracting. Take photos before or after, and keep your phone on silent the whole time."},
        {"n":11,"speaker":"A","text":"Fair enough. I don’t want to look like a tourist, you know. I’ll just enjoy the atmosphere and be quiet."},
        {"n":12,"speaker":"B","text":"Exactly. You’ll be fine — confidence and a smile go with any outfit. Have fun at both events, and tell me how they went!"}
      ]
    },
    {
      "id": "food_hungary",
      "title": "Food in Hungary",
      "situation": "Your foreign friend is staying in Hungary and asks about Hungarian food and eating habits.",
      "functions": ["asking for information","describing","giving recommendations","expressing opinion","contrasting","closing"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, I’m staying in Hungary for a few months, and honestly, I have no idea what people usually eat here. I want to try local food, but I also eat healthy."},
        {"n":2,"speaker":"B","text":"You’ll love it! Hungarian food is special — lots of soups and stews, and yes, paprika. Some dishes are heavy, but there are lighter options too."},
        {"n":3,"speaker":"A","text":"Right, I’ve heard about goulash. Is everything spicy, or can I ask for something milder?"},
        {"n":4,"speaker":"B","text":"Not everything is spicy. You can always ask for less spicy, and many restaurants have international menus as well."},
        {"n":5,"speaker":"A","text":"Good to know. By the way, are there salad bars or places for healthy meals around schools or in the city centre?"},
        {"n":6,"speaker":"B","text":"Yes, more and more. Still, traditional food can be heavy, so maybe balance it with salads or soups. It’s about balance, really."},
        {"n":7,"speaker":"A","text":"Makes sense. And what about school canteens — are they good these days?"},
        {"n":8,"speaker":"B","text":"They’re improving, but, to be honest, it’s a lot of pasta and fried food. It’s okay sometimes, but not every day."},
        {"n":9,"speaker":"A","text":"I get it. I’ll try a mix then — some traditional dishes and some lighter meals."},
        {"n":10,"speaker":"B","text":"Great idea. Start with goulash or chicken paprikash, and then try lángos just once for fun. You can always walk it off later!"},
        {"n":11,"speaker":"A","text":"Haha, fair enough. Thanks for the tips — I’ll keep an open mind and a small plate."},
        {"n":12,"speaker":"B","text":"Perfect. Food is part of culture, so enjoy the experience, and don’t forget dessert once in a while."}
      ]
    },
    {
      "id": "learning_languages",
      "title": "Learning Languages",
      "situation": "Your penfriend wants to learn English faster and asks for practical advice.",
      "functions": ["asking for advice","suggesting strategies","encouraging","sharing personal experience","setting goals"],
      "turns": [
        {"n":1,"speaker":"A","text":"You’re really good at English. How did you learn so fast? I feel stuck, even though I study a lot."},
        {"n":2,"speaker":"B","text":"Thanks! To be honest, films and YouTube helped a lot. I stopped reading subtitles and tried to understand from context."},
        {"n":3,"speaker":"A","text":"That sounds tough. I usually end up reading the subtitles and not listening. Any tricks for grammar, by the way?"},
        {"n":4,"speaker":"B","text":"Learn grammar inside short stories or diary entries. Examples make rules easier, and you remember them longer."},
        {"n":5,"speaker":"A","text":"Okay, that could work. I hate learning vocabulary, though — it just doesn’t stay in my head."},
        {"n":6,"speaker":"B","text":"Use flashcards and repeat small sets daily. Also, label objects at home — it’s silly, but it works."},
        {"n":7,"speaker":"A","text":"Nice idea. Do you ever lose motivation? I do, especially after a long day."},
        {"n":8,"speaker":"B","text":"Of course I do. That’s why I set tiny goals, like ten minutes a day. Small wins keep you going."},
        {"n":9,"speaker":"A","text":"I like that approach. Maybe I’ll try a language app in the evenings, just for a short session."},
        {"n":10,"speaker":"B","text":"Great plan. Mix input and output — watch a short video, then write a few sentences about it. It closes the loop."},
        {"n":11,"speaker":"A","text":"Makes sense. Thanks for the realistic tips — nothing crazy, just steady practice."},
        {"n":12,"speaker":"B","text":"Exactly. A little bit every day beats a lot once a month. You’ll see progress sooner than you think."}
      ]
    },
    {
      "id": "shopping_parties",
      "title": "Shopping & Parties",
      "situation": "You and your friend are planning a weekend party together.",
      "functions": ["planning","negotiating tasks","making suggestions","agreeing politely","logistics"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, about the party on Saturday — we should probably start organizing things. The guest list looks longer than last time."},
        {"n":2,"speaker":"B","text":"You’re right. First, let’s estimate how many people are coming, and then we can decide on food and drinks."},
        {"n":3,"speaker":"A","text":"Okay, around twelve, maybe more if everyone brings someone. Should we cook together, or just order pizza?"},
        {"n":4,"speaker":"B","text":"Ordering is easier, but cooking tacos together could be fun. It also makes the party feel more personal."},
        {"n":5,"speaker":"A","text":"True. For drinks, I’d buy soft drinks and some juice, and maybe ask guests to bring one item each."},
        {"n":6,"speaker":"B","text":"Good plan. I can handle music and decorations — I’ve got lights and a decent playlist."},
        {"n":7,"speaker":"A","text":"Awesome. What about plates and cups? I’d rather avoid too much plastic if possible."},
        {"n":8,"speaker":"B","text":"Same here. We can use reusable ones and wash them after. It’s greener and not that hard."},
        {"n":9,"speaker":"A","text":"Great. Let’s write a shared list so we don’t forget anything. I’ll also post the start time and the buzzer code."},
        {"n":10,"speaker":"B","text":"Perfect. Then we’re set — now let’s just hope nobody spills wine on the carpet this time!"},
        {"n":11,"speaker":"A","text":"Haha, right. Either way, with this plan, it’ll be a success."},
        {"n":12,"speaker":"B","text":"Exactly. Good organization always saves the night — and our nerves."}
      ]
    },
    {
      "id": "travel_plans",
      "title": "Travel Plans",
      "situation": "You and your friend have saved up some money and are planning a hiking trip.",
      "functions": ["weighing options","preferences","budgeting","making decisions","next steps"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, we finally saved enough money. Any ideas where we should go? I’d prefer something active, not just lying on the beach."},
        {"n":2,"speaker":"B","text":"Same here. How about the mountains in Austria or Slovakia? We could hike and take amazing photos."},
        {"n":3,"speaker":"A","text":"That sounds perfect. Train or car, though? Train is cheaper, but a car gives us freedom."},
        {"n":4,"speaker":"B","text":"True. If we rent a car, we can stop anywhere. On the other hand, trains are more relaxing — no driving stress."},
        {"n":5,"speaker":"A","text":"Good point. What about accommodation — hostel, guesthouse, or Airbnb? I’m fine with something simple."},
        {"n":6,"speaker":"B","text":"A small guesthouse could be cosy and cheap. We can cook our own food and save money."},
        {"n":7,"speaker":"A","text":"Great. Speaking of money, what’s our budget per person? I was thinking about 150 euros."},
        {"n":8,"speaker":"B","text":"That should work if we plan meals and skip tourist traps. Let’s also check student discounts."},
        {"n":9,"speaker":"A","text":"Agreed. I’ll look up routes and easy trails for two days. We don’t want to overdo it on day one."},
        {"n":10,"speaker":"B","text":"Exactly. Let’s compare options tonight and book by tomorrow. That way, prices won’t jump."},
        {"n":11,"speaker":"A","text":"Deal. This is going to be a great trip — active, but not stressful."},
        {"n":12,"speaker":"B","text":"Totally. A little planning now means a lot of fun later."}
      ]
    },
    {
      "id": "job_interview",
      "title": "Job Interview",
      "situation": "Your friend has an important job interview and asks for advice.",
      "functions": ["giving advice","dos and don’ts","self-presentation","asking questions","closing politely"],
      "turns": [
        {"n":1,"speaker":"A","text":"I’ve got a job interview tomorrow, and honestly, I’m terrified. I don’t want to freeze or say something silly."},
        {"n":2,"speaker":"B","text":"You’ll be fine. Smile, make eye contact, and speak clearly. First impressions matter, but they’re not everything."},
        {"n":3,"speaker":"A","text":"Okay, thanks. What should I wear, by the way? I don’t want to be overdressed."},
        {"n":4,"speaker":"B","text":"Go smart but simple — a shirt and trousers or a plain dress. Clean shoes and no loud accessories."},
        {"n":5,"speaker":"A","text":"Right. If they ask about weaknesses, what should I say without sounding negative?"},
        {"n":6,"speaker":"B","text":"Pick a real one, but show progress: “I used to rush tasks, but now I plan my week and double-check.” It shows growth."},
        {"n":7,"speaker":"A","text":"Nice. Should I ask questions at the end, or is that annoying?"},
        {"n":8,"speaker":"B","text":"Definitely ask! It shows interest. Ask about the team or the first projects you’d work on."},
        {"n":9,"speaker":"A","text":"Good idea. Is there anything I should avoid completely?"},
        {"n":10,"speaker":"B","text":"Don’t speak badly about past jobs, and don’t ask about salary too early. Keep it positive and curious."},
        {"n":11,"speaker":"A","text":"Got it. Thanks for calming me down — I feel more prepared already."},
        {"n":12,"speaker":"B","text":"Anytime. You’ve got this — just be yourself, and let your motivation show."}
      ]
    },
    {
      "id": "friends_feelings",
      "title": "Friends & Feelings",
      "situation": "Your mutual friend has been feeling sad lately after a breakup; you want to help.",
      "functions": ["showing empathy","making gentle suggestions","offering support","respecting boundaries"],
      "turns": [
        {"n":1,"speaker":"A","text":"Hey, have you talked to Anna recently? She seems really down, and to be honest, I’m a bit worried."},
        {"n":2,"speaker":"B","text":"Yeah, me too. I heard she broke up with her boyfriend, and it hit her hard. She needs time, but not isolation."},
        {"n":3,"speaker":"A","text":"Exactly. Maybe we should invite her out this weekend. Nothing heavy — just coffee and a short walk."},
        {"n":4,"speaker":"B","text":"Good idea. Sometimes a simple chat helps a lot. We can let her lead the conversation."},
        {"n":5,"speaker":"A","text":"Right. I don’t want to make her talk about it if she doesn’t want to. We should just be there for her."},
        {"n":6,"speaker":"B","text":"Agreed. I’ll text her something gentle like, “We miss you — want to hang out?” No pressure, just care."},
        {"n":7,"speaker":"A","text":"Perfect. If she says yes, we’ll plan something quiet and friendly. If not, we’ll try again next week."},
        {"n":8,"speaker":"B","text":"Yeah. Healing takes time, you know. But having friends around makes it easier."},
        {"n":9,"speaker":"A","text":"True. I’ll send the message now and keep it simple. I hope she feels better soon."},
        {"n":10,"speaker":"B","text":"Same here. Even small steps count — a laugh, a warm drink, and a safe space."},
        {"n":11,"speaker":"A","text":"Exactly. Thanks for helping me think this through. It already feels more hopeful."},
        {"n":12,"speaker":"B","text":"Anytime. That’s what friends are for — steady support, not big speeches."}
      ]
    },
    {
      "id": "buying_presents",
      "title": "Buying Presents",
      "situation": "You’re choosing Christmas gifts for your parents and best friend.",
      "functions": ["brainstorming","narrowing options","budgeting","polite disagreement","final decision"],
      "turns": [
        {"n":1,"speaker":"A","text":"I have no idea what to buy for my parents this Christmas. They seem to have everything already."},
        {"n":2,"speaker":"B","text":"I know the feeling. When in doubt, go personal — a photo album, homemade cookies, or a letter. It’s the thought that counts."},
        {"n":3,"speaker":"A","text":"True, that could work. And what about my best friend? I want something special but not too expensive."},
        {"n":4,"speaker":"B","text":"Well, what’s she into these days? Music, books, or maybe experiences like a workshop?"},
        {"n":5,"speaker":"A","text":"She loves music and reading. Concert tickets sound cool, but dates are tricky."},
        {"n":6,"speaker":"B","text":"Then a carefully chosen book with a note inside could be perfect. It’s simple, but it lasts."},
        {"n":7,"speaker":"A","text":"Nice idea. How much should I spend, though? I’m on a student budget."},
        {"n":8,"speaker":"B","text":"Set a limit and stick to it — price doesn’t equal value. A personal message adds heart for free."},
        {"n":9,"speaker":"A","text":"You’re right. I’ll pick something meaningful and write a proper card."},
        {"n":10,"speaker":"B","text":"Great plan. Gifts are really about connection, not price tags."},
        {"n":11,"speaker":"A","text":"Exactly. Thanks for the nudge — now it feels doable."},
        {"n":12,"speaker":"B","text":"Anytime. Shopping is easier when you know what you want to say with the gift."}
      ]
    },
    {
      "id": "invitations_arrangements",
      "title": "Invitations and Arrangements",
      "situation": "You’re inviting a friend to hang out and finalizing practical details.",
      "functions": ["inviting","accepting/refusing politely","fixing time and place","logistics","friendly close"],
      "turns": [
        {"n":1,"speaker":"A","text":"Hey, are you free this weekend? I was thinking we could try that new café downtown."},
        {"n":2,"speaker":"B","text":"Let me check… yeah, I’m free on Saturday afternoon. I’ve heard good things about that place."},
        {"n":3,"speaker":"A","text":"Great! How about three o’clock? It’s quieter then, and we can actually talk."},
        {"n":4,"speaker":"B","text":"Perfect. Is it close to the metro? I don’t want to get lost again."},
        {"n":5,"speaker":"A","text":"Yes, two minutes from the station — even you can’t miss it! I’ll send you the location just in case."},
        {"n":6,"speaker":"B","text":"Haha, thanks. Should I bring anything, or just my charming personality?"},
        {"n":7,"speaker":"A","text":"Just yourself is fine — and your good mood. We’ll keep it simple."},
        {"n":8,"speaker":"B","text":"Sounds good. How long are you thinking of staying? I have a family dinner later."},
        {"n":9,"speaker":"A","text":"No problem. Let’s do an hour or two and keep it flexible. We can always continue next time."},
        {"n":10,"speaker":"B","text":"Nice plan. By the way, can I bring Anna if she’s free?"},
        {"n":11,"speaker":"A","text":"Sure, the more, the merrier. I’ll book a table for three just to be safe."},
        {"n":12,"speaker":"B","text":"Awesome. See you on Saturday — and thanks for organising!"}
      ]
    },
    {
      "id": "apologies_problems",
      "title": "Apologies and Problems",
      "situation": "You forgot your friend’s birthday and want to apologize and make amends.",
      "functions": ["apologizing","accepting apologies","offering to make up","light humour","closing politely"],
      "turns": [
        {"n":1,"speaker":"A","text":"Hey, listen… I’m really sorry I forgot your birthday yesterday. I honestly set a reminder, but somehow I still missed it."},
        {"n":2,"speaker":"B","text":"Oh, don’t worry — these things happen. I know you’ve been busy, and I’m not angry."},
        {"n":3,"speaker":"A","text":"Still, I feel bad. Let me make it up to you — how about coffee and cake tomorrow afternoon? My treat."},
        {"n":4,"speaker":"B","text":"That actually sounds perfect. And, well, cake does help with forgiveness!"},
        {"n":5,"speaker":"A","text":"Deal. I’ll choose a place with good cheesecake, just to be safe."},
        {"n":6,"speaker":"B","text":"Excellent choice. By the way, thanks for saying sorry so quickly — it means a lot."},
        {"n":7,"speaker":"A","text":"Of course. Friendship first, birthdays second. I’ll do better next year."},
        {"n":8,"speaker":"B","text":"No pressure — just set two reminders next time. Or three!"},
        {"n":9,"speaker":"A","text":"Haha, noted. Thanks for being understanding and kind about it."},
        {"n":10,"speaker":"B","text":"Always. Real friends forgive, and then they eat cake together. See you tomorrow!"},
        {"n":11,"speaker":"A","text":"See you! And thanks again for organising this so quickly."},
        {"n":12,"speaker":"B","text":"Anytime. We’ll turn a mistake into a memory."}
      ]
    },
    {
      "id": "doctors_health",
      "title": "At the Doctor’s / Health Issues",
      "situation": "Your friend doesn’t feel well and you give practical advice and support.",
      "functions": ["asking about symptoms","giving advice","encouraging rest","if-not-then advice","closing with care"],
      "turns": [
        {"n":1,"speaker":"A","text":"You don’t look too good today. Are you okay, or is it just a long week catching up with you?"},
        {"n":2,"speaker":"B","text":"Not great, to be honest. I’ve had a terrible headache since yesterday, and painkillers didn’t help much."},
        {"n":3,"speaker":"A","text":"Oh no. Have you been drinking enough water and sleeping properly? Dehydration can make it worse."},
        {"n":4,"speaker":"B","text":"Probably not. I stayed up late studying, and I forgot to refill my bottle."},
        {"n":5,"speaker":"A","text":"Right, that explains a lot. Rest a bit today, drink water, and keep the room quiet and dark."},
        {"n":6,"speaker":"B","text":"Sounds sensible. I’ll try a short nap this afternoon and see if that helps."},
        {"n":7,"speaker":"A","text":"Good plan. And if it doesn’t get better, please see a doctor tomorrow. Better safe than sorry."},
        {"n":8,"speaker":"B","text":"You’re right. I sometimes wait too long, but this time I’ll go if it continues."},
        {"n":9,"speaker":"A","text":"Great. Text me later to say how you’re doing, okay? I’m a bit worried."},
        {"n":10,"speaker":"B","text":"Thanks, I will. It’s nice to feel cared for — that already helps."},
        {"n":11,"speaker":"A","text":"Of course. Health first, everything else second."},
        {"n":12,"speaker":"B","text":"Exactly. I’ll slow down today and catch up on rest."}
      ]
    },
    {
      "id": "at_restaurant",
      "title": "At a Restaurant",
      "situation": "You’re eating out with a friend; something is wrong with the order, and you handle it politely.",
      "functions": ["ordering","requesting politely","complaining politely","apologizing","positive close"],
      "turns": [
        {"n":1,"speaker":"A","text":"Excuse me, could we have the menus, please? We’ve been looking forward to trying this place all week."},
        {"n":2,"speaker":"B","text":"Of course — here you are. Today’s specials are on the first page, if you’re interested."},
        {"n":3,"speaker":"A","text":"Thanks, that helps. I might try the chicken curry, and maybe we can share a salad to start."},
        {"n":4,"speaker":"B","text":"Good idea. I’ll go for the grilled salmon with rice. And some mineral water for both of us, please."},
        {"n":5,"speaker":"A","text":"Perfect. (later) Wow, the dishes look amazing! The presentation is really nice."},
        {"n":6,"speaker":"B","text":"Yeah, but actually, mine is a bit cold. I’m not sure if it waited too long on the counter."},
        {"n":7,"speaker":"A","text":"Oh dear. Should we call the waiter and ask them to reheat it? We can be polite about it."},
        {"n":8,"speaker":"B","text":"Yes, let’s do that. Excuse me, the chicken is a little cold — could you heat it up, please?"},
        {"n":9,"speaker":"A","text":"I’m very sorry about that. I’ll take it back to the kitchen right away and bring you a hot one."},
        {"n":10,"speaker":"B","text":"Thank you so much. We really appreciate your help — and the food looks delicious otherwise."},
        {"n":11,"speaker":"A","text":"No problem at all. Thanks for telling me politely — we’ll fix it immediately."},
        {"n":12,"speaker":"B","text":"That was handled so well. Being calm and polite really works, doesn’t it?"}
      ]
    },
    {
      "id": "directions",
      "title": "Asking for and Giving Directions",
      "situation": "You help a tourist find the train station safely and quickly.",
      "functions": ["asking for directions","giving clear instructions","checking understanding","friendly close"],
      "turns": [
        {"n":1,"speaker":"A","text":"Excuse me, could you tell me how to get to the train station? I think I’m a bit lost."},
        {"n":2,"speaker":"B","text":"Sure! Go straight for two blocks, then turn left at the big bookstore. Keep walking until you see a park on your right."},
        {"n":3,"speaker":"A","text":"Okay, and the station is after the park, right? I don’t want to miss it."},
        {"n":4,"speaker":"B","text":"Yes, it’s just behind the park — you’ll see the signs. It’s about a ten-minute walk from here."},
        {"n":5,"speaker":"A","text":"Great, thanks. Is there a bus as well, in case it starts raining?"},
        {"n":6,"speaker":"B","text":"Yes, bus number 9 stops right there and goes directly to the station. The stop is across the street."},
        {"n":7,"speaker":"A","text":"Perfect. Thanks for the clear directions — that really helps."},
        {"n":8,"speaker":"B","text":"You’re welcome. Be careful at the big crossing near the park — the lights change quickly."},
        {"n":9,"speaker":"A","text":"Good to know. I’ll watch out and cross with the crowd."},
        {"n":10,"speaker":"B","text":"Excellent. Have a safe trip, and enjoy your day!"},
        {"n":11,"speaker":"A","text":"Thanks again for your kindness. People here are really helpful."},
        {"n":12,"speaker":"B","text":"Glad to hear that. Take care and good luck with your journey."}
      ]
    },
    {
      "id": "making_complaint",
      "title": "Making a Complaint",
      "situation": "You return a defective product and resolve the issue politely in a shop.",
      "functions": ["stating the problem","providing proof","requesting solution","accepting apology","positive close"],
      "turns": [
        {"n":1,"speaker":"A","text":"Good morning. I’d like to return this jacket — the zipper broke on the second day, which is disappointing."},
        {"n":2,"speaker":"B","text":"I’m very sorry to hear that. Do you happen to have the receipt with you so I can check the purchase?"},
        {"n":3,"speaker":"A","text":"Yes, here it is. I bought it two days ago, and I really liked the design, so I was surprised."},
        {"n":4,"speaker":"B","text":"I understand, and thank you for bringing it back quickly. Would you prefer an exchange or a refund today?"},
        {"n":5,"speaker":"A","text":"If possible, I’d like to exchange it for the same model. I’m hoping this was just a rare fault."},
        {"n":6,"speaker":"B","text":"No problem — let me check our stock. Ah, we have your size in one other colour."},
        {"n":7,"speaker":"A","text":"That’s fine with me. Could I try it on to be sure the zipper works smoothly this time?"},
        {"n":8,"speaker":"B","text":"Of course — the fitting rooms are to your left. Take your time."},
        {"n":9,"speaker":"A","text":"Thanks. (later) This one seems perfect — the zipper is smooth and the fit is good."},
        {"n":10,"speaker":"B","text":"Great! Again, I’m sorry for the inconvenience, and thank you for your patience."},
        {"n":11,"speaker":"A","text":"No worries. I appreciate the quick help and the polite service today."},
        {"n":12,"speaker":"B","text":"You’re welcome. Have a lovely day, and enjoy your new jacket."}
      ]
    },
    {
      "id": "opinions_preferences",
      "title": "Expressing Opinions and Preferences",
      "situation": "You discuss a film you both watched, offering reasons and polite disagreement.",
      "functions": ["giving opinion","agreeing/disagreeing politely","asking reasons","conceding a point","suggesting next step"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, did you finally watch the new superhero film? I’m curious what you thought, because I have mixed feelings."},
        {"n":2,"speaker":"B","text":"I did, and to be honest, I didn’t love it. The action was great, but the story felt a bit flat to me."},
        {"n":3,"speaker":"A","text":"Interesting. I actually enjoyed it, mainly for the special effects and the music. They were pretty epic."},
        {"n":4,"speaker":"B","text":"True, the soundtrack was amazing. Still, the plot was predictable — I guessed the ending halfway through."},
        {"n":5,"speaker":"A","text":"Fair point. I guess I was just in the mood for something fun and light. Not every film needs to be deep."},
        {"n":6,"speaker":"B","text":"Exactly. It’s fine for entertainment, but it won’t be my favourite. What’s yours, by the way?"},
        {"n":7,"speaker":"A","text":"Probably Inception — it makes me think, and I love the atmosphere. It stays with you after it ends."},
        {"n":8,"speaker":"B","text":"Same here. I like films that leave a question in your head. Maybe we should pick something like that next time."},
        {"n":9,"speaker":"A","text":"Good idea. Let’s watch something more artistic next weekend, and then we can compare notes."},
        {"n":10,"speaker":"B","text":"Deal. I’ll bring popcorn, and you choose the film. That way we both win."},
        {"n":11,"speaker":"A","text":"Perfect. A proper movie night beats scrolling on our phones anyway."},
        {"n":12,"speaker":"B","text":"Agreed. Real conversations make films more interesting."}
      ]
    },
    {
      "id": "school_learning",
      "title": "School and Learning",
      "situation": "You and your classmate are planning your school project together.",
      "functions": ["planning","dividing work","scheduling","agreeing","motivating"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, we really need to start working on our science project. The deadline is next week, and I don’t want to leave it to the last minute again."},
        {"n":2,"speaker":"B","text":"Yeah, I totally agree. We always say that and then end up working all night before it’s due! Let’s plan it properly this time."},
        {"n":3,"speaker":"A","text":"Absolutely. So, what topic should we choose? I was thinking about renewable energy — it’s current and there’s a lot to talk about."},
        {"n":4,"speaker":"B","text":"That’s a great idea. It’s interesting, and we can easily find information online. Maybe we could also make a short presentation with slides."},
        {"n":5,"speaker":"A","text":"Good point. You’re good at visuals, so you could work on the slides, and I’ll write the main text. Does that sound fair?"},
        {"n":6,"speaker":"B","text":"Yeah, totally. Oh, and we could add a short video about solar panels — that would make it more engaging."},
        {"n":7,"speaker":"A","text":"Nice one! By the way, when should we meet to work on it? Friday after school?"},
        {"n":8,"speaker":"B","text":"Hmm, Friday might be tricky for me. How about Saturday morning? I’m free then."},
        {"n":9,"speaker":"A","text":"Works for me. We can meet at my place — it’s quiet, and we’ll actually get things done."},
        {"n":10,"speaker":"B","text":"Perfect. Let’s aim to finish the draft that day, so we have time to practise."},
        {"n":11,"speaker":"A","text":"Deal. You know, for once, we might actually finish before the deadline!"},
        {"n":12,"speaker":"B","text":"Haha, right! Miracles do happen. But seriously, this time we’ve got a solid plan."}
      ]
    },
    {
      "id": "tech_social",
      "title": "Technology and Social Media",
      "situation": "You’re discussing the role of social media in everyday life.",
      "functions": ["discussing pros and cons","expressing concern","suggesting changes","agreeing"],
      "turns": [
        {"n":1,"speaker":"A","text":"You know, I’ve been thinking — people really spend way too much time on their phones these days. Everywhere I look, someone’s scrolling."},
        {"n":2,"speaker":"B","text":"Yeah, you’re right, but at the same time, social media helps us stay connected. I mean, I talk to my cousins abroad almost every day because of it."},
        {"n":3,"speaker":"A","text":"That’s true, but don’t you ever feel like it’s too much? I sometimes get tired of all the constant updates and photos."},
        {"n":4,"speaker":"B","text":"Oh, absolutely. It can be overwhelming. Sometimes I even delete the apps for a few days, just to have a break."},
        {"n":5,"speaker":"A","text":"I should try that too. I keep saying I’ll spend less time online, but then I find myself on TikTok at midnight."},
        {"n":6,"speaker":"B","text":"Same here! It’s addictive, you know. They design those apps to keep you scrolling."},
        {"n":7,"speaker":"A","text":"Yeah, and people compare themselves to others all the time. It’s not very healthy, emotionally speaking."},
        {"n":8,"speaker":"B","text":"Exactly. That’s why I follow positive accounts — like travel pages or language-learning ones. It makes scrolling feel less pointless."},
        {"n":9,"speaker":"A","text":"That’s actually a smart idea. Maybe I’ll do that too, instead of watching random videos."},
        {"n":10,"speaker":"B","text":"Or we could challenge each other — one “no-phone Sunday” every week."},
        {"n":11,"speaker":"A","text":"I love that! We could even go for a walk or grab coffee instead."},
        {"n":12,"speaker":"B","text":"Perfect. Real-life conversations beat online chats any day."}
      ]
    },
    {
      "id": "environment_habits",
      "title": "Environment and Daily Habits",
      "situation": "You’re talking about how to live a more eco-friendly lifestyle.",
      "functions": ["suggesting changes","sharing habits","encouraging","agreeing"],
      "turns": [
        {"n":1,"speaker":"A","text":"You know, I’ve really started to think more about the environment lately. It’s kind of scary how much waste we produce."},
        {"n":2,"speaker":"B","text":"Yeah, tell me about it. I saw a documentary about plastic pollution last week, and it was shocking. It made me want to change a few habits."},
        {"n":3,"speaker":"A","text":"Same here. For example, I stopped buying plastic bottles and use a reusable one instead. It’s such a small change, but it feels good."},
        {"n":4,"speaker":"B","text":"That’s great! I’ve started carrying my own shopping bag too — no more plastic ones. It’s actually cheaper in the long run."},
        {"n":5,"speaker":"A","text":"That’s true. Do you also recycle at home?"},
        {"n":6,"speaker":"B","text":"Yeah, we’ve got separate bins now. At first it was annoying, but now it’s just part of the routine."},
        {"n":7,"speaker":"A","text":"I guess that’s the key — turning it into a habit. By the way, do you use public transport?"},
        {"n":8,"speaker":"B","text":"Most of the time, yeah. I try not to use the car unless it’s really necessary. Walking is good for your health anyway."},
        {"n":9,"speaker":"A","text":"I couldn’t agree more. I’ve even started turning off lights whenever I leave a room — my parents love that!"},
        {"n":10,"speaker":"B","text":"Haha, I bet they do. You’re saving money and the planet at the same time."},
        {"n":11,"speaker":"A","text":"Right. It’s funny how easy it is to make small changes that actually matter."},
        {"n":12,"speaker":"B","text":"Exactly. If everyone did just a little, the world would be a very different place."}
      ]
    },
    {
      "id": "tourism_budapest",
      "title": "Travelling and Tourism",
      "situation": "You’re planning what to show a foreign friend visiting Budapest.",
      "functions": ["recommending sights","planning","booking","closing positively"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, my friend from Italy is coming for the weekend, and I want to show her the best parts of Budapest. Any ideas?"},
        {"n":2,"speaker":"B","text":"Oh, definitely! Start with the Castle District — the view from there is incredible. And maybe the Parliament building too, it’s iconic."},
        {"n":3,"speaker":"A","text":"Good thinking. What about something in the evening? She loves music and food."},
        {"n":4,"speaker":"B","text":"Then take her to a ruin bar! They’re such a big part of Budapest culture. Maybe Szimpla — it’s the most famous one."},
        {"n":5,"speaker":"A","text":"Yeah, that’s a must-see. Should I also show her the thermal baths?"},
        {"n":6,"speaker":"B","text":"Oh, absolutely! The Széchenyi Baths are amazing. It’s such a unique experience, especially if the weather’s nice."},
        {"n":7,"speaker":"A","text":"Great. I was also thinking about taking her for a walk along the Danube in the evening. The lights are beautiful."},
        {"n":8,"speaker":"B","text":"That’s perfect — and you could finish with some Hungarian food. Maybe take her to Menza or Paprika restaurant."},
        {"n":9,"speaker":"A","text":"I like that idea. Should I book a table, though? It gets crowded."},
        {"n":10,"speaker":"B","text":"Yeah, better safe than sorry. And tell her to bring comfortable shoes — there’s a lot of walking involved!"},
        {"n":11,"speaker":"A","text":"True. I hope she’ll love the city as much as I do."},
        {"n":12,"speaker":"B","text":"I’m sure she will. Budapest never disappoints — especially with you as a guide!"}
      ]
    },
    {
      "id": "work_ambitions",
      "title": "Work and Ambitions",
      "situation": "You’re discussing future career goals and dreams.",
      "functions": ["asking plans","explaining reasons","encouraging","reflecting"],
      "turns": [
        {"n":1,"speaker":"A","text":"So, have you ever thought about what job you’d like to have in the future? I mean, after school and all that."},
        {"n":2,"speaker":"B","text":"Yeah, I think about it all the time actually. I’d love to be a graphic designer — something creative, you know."},
        {"n":3,"speaker":"A","text":"That’s cool! You’ve always been good at drawing. Why design, though?"},
        {"n":4,"speaker":"B","text":"Because it combines art and technology, which I really enjoy. Plus, you can work from anywhere if you’re good enough."},
        {"n":5,"speaker":"A","text":"True. Do you plan to study design at university?"},
        {"n":6,"speaker":"B","text":"Yeah, that’s the plan. I’ve already looked at a few schools that offer good programs."},
        {"n":7,"speaker":"A","text":"Nice! I’m still not sure what I want to do. I keep changing my mind every month."},
        {"n":8,"speaker":"B","text":"That’s okay — most people our age don’t have it all figured out. You’ll find something you’re passionate about."},
        {"n":9,"speaker":"A","text":"I hope so. I just don’t want to end up in a job I hate, you know?"},
        {"n":10,"speaker":"B","text":"Of course. The important thing is to do something meaningful — something that motivates you."},
        {"n":11,"speaker":"A","text":"Yeah, you’re right. I guess the key is not giving up, even if it’s hard."},
        {"n":12,"speaker":"B","text":"Exactly. A bit of hard work, a bit of luck, and who knows — we might both end up loving what we do."}
      ]
    }
  ]
}
</script>

<script>
(function(){
  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  let DB=null, topic=null, state=null;

  const els = {
    file: $('#jsonFile'), dbStatus: $('#dbStatus'), topicSelect: $('#topicSelect'),
    startBtn: $('#startBtn'), scorePill: $('#scorePill'), modePill: $('#modePill'),
    tabs: $$('.tab'),
    buildPrev: $('#buildPrev'), buildOptions: $('#buildOptions'),
    buildShow: $('#buildShow'), buildNext: $('#buildNext'), buildFeedback: $('#buildFeedback'), buildProg: $('#buildProg'),
    clozeArea: $('#clozeArea'), clozeCheck: $('#clozeCheck'), clozeHint: $('#clozeHint'), clozeSolve: $('#clozeSolve'),
    clozeLevel: $('#clozeLevel'), clozeStats: $('#clozeStats'), clozeFeedback: $('#clozeFeedback'),
    orderList: $('#orderList'), orderCheck: $('#orderCheck'), orderSolve: $('#orderSolve'), orderFeedback: $('#orderFeedback'),
    speakRole: $('#speakRole'), speakPrompt: $('#speakPrompt'), speakSolution: $('#speakSolution'),
    sSpeak: $('#sSpeak'), sSaid: $('#sSaid'), sStruggled: $('#sStruggled'), sNext: $('#sNext'),
    saidCnt: $('#saidCnt'), struggledCnt: $('#struggledCnt'), seeCnt: $('#seeCnt')
  };

  // Load embedded DB (fallback to last version in localStorage if empty script tag)
  try{
    const raw = document.getElementById('embedded-db').textContent.trim();
    if(raw && !raw.startsWith('<!--')) DB = JSON.parse(raw);
    else{
      // try to retrieve previously saved embedded DB
      const cached = localStorage.getItem('cbuilder:embeddedDB');
      if(cached) DB = JSON.parse(cached);
    }
    if(DB){ els.dbStatus.textContent = `Beágyazott DB: ${DB.topics.length} téma`; localStorage.setItem('cbuilder:embeddedDB', JSON.stringify(DB)); }
  }catch(err){ els.dbStatus.textContent = 'Hiba a beágyazott DB-vel: '+err.message; }

  // If still no DB, show minimal message
  if(!DB){ els.dbStatus.textContent = 'Hiányzik a beágyazott DB. Töltsd be a JSON-t a bal oldali gombbal.'; }

  // Optional external JSON override
  els.file.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      DB = JSON.parse(await f.text());
      els.dbStatus.textContent = `Betöltve: ${f.name} (${DB.topics.length} téma)`;
      localStorage.setItem('cbuilder:embeddedDB', JSON.stringify(DB));
      hydrateTopics();
    }catch(err){ els.dbStatus.textContent='Hibás JSON: '+err.message; }
  });

  function hydrateTopics(){
    if(!DB?.topics?.length){ els.topicSelect.innerHTML=''; return; }
    els.topicSelect.innerHTML = DB.topics.map(t=>`<option value="${t.id}">${t.title}</option>`).join('');
    els.startBtn.disabled = !els.topicSelect.value;
  }
  hydrateTopics();

  els.topicSelect.addEventListener('change', ()=>{
    const id=els.topicSelect.value; topic = DB?.topics?.find(t=>t.id===id);
    els.startBtn.disabled = !topic;
  });

  els.startBtn.addEventListener('click', ()=>{
    if(!topic){ const id=els.topicSelect.value; topic = DB.topics.find(t=>t.id===id); }
    initState(); switchTab('build'); setupBuild(); updateHud();
  });

  // Free navigation between tabs
  els.tabs.forEach(tab=>tab.addEventListener('click',()=> switchTab(tab.dataset.tab)));

  function switchTab(name){
    $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
    ['build','cloze','order','speak'].forEach(id=>{ $('#'+id).hidden = (id!==name); });
    els.modePill.textContent = `Mód: ${name.toUpperCase()}`;
    if(!topic) return;
    if(name==='build') setupBuild();
    if(name==='cloze') setupCloze();
    if(name==='order') setupOrder();
    if(name==='speak') setupSpeak();
  }

  // State
  function key(){ return `cbuilder:v2:${topic?.id??'none'}`; }
  function saveState(){ if(topic) localStorage.setItem(key(), JSON.stringify(state)); }
  function loadState(){ const raw=topic&&localStorage.getItem(key()); state=raw?JSON.parse(raw):null; if(!state) initState(); }
  function initState(){
    state = { score:0,
      build:{ step:1, results:{} },
      cloze:{ level:'A', blanks:[], stats:{correct:0,total:0} },
      order:{ solved:false, locked:false },
      speak:{ idx:0, role:'B', said:0, struggled:0, seen:0 }
    }; saveState();
  }
  function setScore(delta){ if(delta>0){ state.score += delta; updateHud(); saveState(); } }
  function updateHud(){ els.scorePill.textContent = `Pont: ${state?.score??0}`; }

  // ===== MODE 1: BUILD (instant feedback on click) =====
  function setupBuild(){
    loadState();
    const turns = topic.turns;
    const step = Math.min(state.build.step, turns.length-1);
    els.buildPrev.textContent = (step<=1) ? `[Start] ${turns[0].speaker}: ${turns[0].text}` : `${turns[step-1].speaker}: ${turns[step-1].text}`;
    const targetIdx = step, correct = turns[targetIdx];
    const options = generateMCQOptions(turns, targetIdx, correct);
    renderMCQ(options, correct, targetIdx);
    const totalSteps = turns.length-1; const done = Math.min(step-1, totalSteps);
    els.buildProg.style.width = `${Math.floor(done/totalSteps*100)}%`;
    els.buildFeedback.textContent=''; els.buildNext.disabled=true;
  }
  function generateMCQOptions(turns, idx, correct){
    const opts = [{ text:`${correct.speaker}: ${correct.text}`, key:'correct' }];
    const laterSame = turns.slice(idx+1).filter(t=>t.speaker===correct.speaker);
    if(laterSame.length){ const d = laterSame[Math.floor(Math.random()*laterSame.length)];
      opts.push({ text:`${d.speaker}: ${d.text}`, key:'later' }); }
    const bank = [
      "A: Maybe we should think about it for a second.",
      "B: I see your point, but I’m not fully convinced yet.",
      "A: That sounds reasonable. Let’s go with that for now."
    ];
    opts.push({ text: bank[Math.floor(Math.random()*bank.length)], key:'bank' });
    while(opts.length<3){ const r=turns[Math.floor(Math.random()*turns.length)];
      opts.push({text:`${r.speaker}: ${r.text}`, key:'rand'}); }
    for(let i=opts.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [opts[i],opts[j]]=[opts[j],opts[i]]; }
    return opts.slice(0,3);
  }
  function renderMCQ(options, correct, targetIdx){
    els.buildOptions.innerHTML=''; let judged=false;
    options.forEach((o,i)=>{
      const div=document.createElement('div');
      div.className='opt'; div.tabIndex=0; div.textContent=o.text;
      div.addEventListener('click',()=>judge(i));
      div.addEventListener('keydown',ev=>{ if(['Enter',' '].includes(ev.key)) judge(i); });
      els.buildOptions.appendChild(div);
    });
    function judge(i){
      if(judged) return; judged=true;
      const nodes=$$('.opt');
      nodes.forEach((n,k)=>{ const ok = options[k].text.startsWith(correct.speaker+':'); n.classList.add(ok?'correct':'wrong'); n.style.pointerEvents='none'; });
      const ok = options[i].text.startsWith(correct.speaker+':');
      const keyTurn = `t${targetIdx}`;
      if(ok){
        els.buildFeedback.innerHTML = `<span class="pill ok">Helyes</span>`;
        if(!state.build.results[keyTurn]){ state.build.results[keyTurn]='correct'; setScore(10); }
      }else{
        els.buildFeedback.innerHTML = `<span class="pill bad">Nem jó</span>`;
        if(!state.build.results[keyTurn]) state.build.results[keyTurn]='wrong_once';
      }
      els.buildNext.disabled=false;
      saveState();
    }
    els.buildShow.onclick=()=>{
      const nodes=$$('.opt'); nodes.forEach((n,k)=>{ const ok=options[k].text.startsWith(correct.speaker+':'); n.classList.add(ok?'correct':'wrong'); n.style.pointerEvents='none'; });
      els.buildFeedback.innerHTML=`<span class="pill warn">Megoldás megjelenítve</span> 0 pont.`;
      const keyTurn=`t${targetIdx}`; if(!state.build.results[keyTurn]) state.build.results[keyTurn]='revealed';
      els.buildNext.disabled=false; saveState();
    };
    els.buildNext.onclick=()=>{ state.build.step=Math.min(state.build.step+1, topic.turns.length-1); saveState(); setupBuild(); };
    window.onkeydown = (ev)=>{ if($('#build').hidden) return; if(['1','2','3'].includes(ev.key)){ const i=parseInt(ev.key)-1; const n=$$('.opt')[i]; n&&n.click(); } if(ev.key==='Enter' && !els.buildNext.disabled){ els.buildNext.click(); } };
  }

  // ===== MODE 2: CLOZE (live blur feedback) =====
  const STOP_A = ["well","so","actually","you know","i mean","just","really","still","even","already","yet","then","too"];
  const AUX_PREP = ["am","is","are","was","were","be","being","been","do","does","did","have","has","had","will","would","can","could","should","may","might","that","which","who","because","but","and","or","if","though","although","at","in","on","to","for","of","with","by","from"];
  const norm = s => (s||"").replace(/\s+/g,' ').trim().toLowerCase();

  function setupCloze(){
    loadState();
    els.clozeArea.innerHTML=''; const level = state.cloze.level; els.clozeLevel.value=level;
    const maskSet = new Set(level==='A' ? STOP_A : [...STOP_A, ...AUX_PREP]);
    const turns = topic.turns; const blanks=[];
    turns.forEach((t, idx)=>{
      const line = maskLine(t.text, maskSet);
      const div = document.createElement('div');
      div.className='cloze-line'; div.dataset.turn=idx+1;
      div.innerHTML = `<span class="pill" style="margin-right:8px">${t.speaker}</span>` + line.html;
      els.clozeArea.appendChild(div);
      line.ids.forEach(b=> blanks.push(b));
    });
    state.cloze.blanks = blanks.map(b=>({id:b.id, ans:b.ans, correct:false}));
    state.cloze.stats.total = blanks.length; state.cloze.stats.correct = 0;
    els.clozeStats.textContent = `0/${blanks.length}`; els.clozeFeedback.textContent=''; saveState();

    // live blur feedback
    state.cloze.blanks.forEach(b=>{
      const inp = document.getElementById(b.id);
      inp.addEventListener('blur', ()=>{
        if(b.correct) return;
        const val = norm(inp.value);
        if(!val) return;
        if(val===norm(b.ans)){ b.correct=true; inp.classList.remove('wrong'); inp.classList.add('correct'); inp.disabled=true; recount(); saveState(); }
        else{ inp.classList.add('wrong'); }
      });
      inp.addEventListener('input', ()=>{ inp.classList.remove('wrong'); }); // typing clears red
    });

    els.clozeCheck.onclick=()=>{ // final sweep
      state.cloze.blanks.forEach(b=>{
        if(b.correct) return;
        const inp=document.getElementById(b.id);
        const val=norm(inp.value);
        if(val && val===norm(b.ans)){ b.correct=true; inp.classList.add('correct'); inp.disabled=true; }
        else if(val){ inp.classList.add('wrong'); }
      });
      recount(); saveState();
    };
    els.clozeHint.onclick=()=>{
      const next = state.cloze.blanks.find(b=>!b.correct);
      if(!next) return; const inp=document.getElementById(next.id);
      if(inp && next.ans && !inp.value){ inp.value = next.ans[0]; inp.focus(); }
      els.clozeFeedback.textContent='Hint megadva (0 pont).';
    };
    els.clozeSolve.onclick=()=>{
      state.cloze.blanks.forEach(b=>{ const inp=document.getElementById(b.id); inp.value=b.ans; inp.classList.add('correct'); inp.disabled=true; b.correct=true; });
      recount(); els.clozeFeedback.innerHTML=`<span class="pill warn">Megoldás megjelenítve</span> 0 pont.`; saveState();
    };
    els.clozeLevel.onchange = ()=>{ state.cloze.level = els.clozeLevel.value; saveState(); setupCloze(); };

    window.onkeydown = ev=>{ if($('#cloze').hidden) return; if(ev.key==='Enter'){ els.clozeCheck.click(); } };

    function recount(){
      state.cloze.stats.correct = state.cloze.blanks.filter(x=>x.correct).length;
      els.clozeStats.textContent = `${state.cloze.stats.correct}/${state.cloze.stats.total}`;
      if(state.cloze.stats.correct===state.cloze.stats.total){ setScore(10); }
    }
  }
  function maskLine(text, maskSet){
    const parts = text.split(/(\b)/); const ids=[]; let html='';
    for(let i=0;i<parts.length;i++){
      const tok = parts[i];
      if(i%2===1){ html+=tok; continue; } // word boundary token
      const w = tok; const lw=w.toLowerCase();
      if(maskSet.has(lw) && /\w/.test(lw)){
        const id='blank_'+Math.random().toString(36).slice(2,8);
        html += `<input id="${id}" class="blank" autocomplete="off" />`; ids.push({id, ans:w.trim()});
      }else html+=w;
    }
    return { html, ids };
  }

  // ===== MODE 3: ORDER =====
  let orderItems=[];
  function setupOrder(){
    loadState();
    orderItems = topic.turns.map((t,i)=>({i, role:t.speaker, text:t.text}));
    orderItems = shuffle(orderItems);
    renderOrder(false); els.orderFeedback.textContent='';
    els.orderCheck.onclick=()=>{
      const correct = orderItems.reduce((a,it,idx)=>a+(it.i===idx?1:0),0);
      if(correct===orderItems.length){
        els.orderFeedback.innerHTML = `<span class="pill ok">Kiváló</span> Minden a helyén.`;
        if(!state.order.solved){ setScore(10); state.order.solved=true; saveState(); }
      }else{
        els.orderFeedback.innerHTML = `<span class="pill warn">Még nem tökéletes</span> ${correct}/${orderItems.length} jó helyen.`;
      }
    };
    els.orderSolve.onclick=()=>{
      orderItems = topic.turns.map((t,i)=>({i, role:t.speaker, text:t.text}));
      renderOrder(true); els.orderFeedback.innerHTML = `<span class="pill warn">Megoldás megjelenítve</span> 0 pont.`; state.order.locked=true; saveState();
    };
    window.onkeydown = ev=>{ if($('#order').hidden) return; if(ev.key==='Enter'){ els.orderCheck.click(); } };
  }
  function renderOrder(showCorrect){
    const list=els.orderList; list.innerHTML='';
    orderItems.forEach((it,idx)=>{
      const div=document.createElement('div'); div.className='order-item'; div.draggable=!showCorrect;
      div.innerHTML = `<span class="role">${showCorrect? it.i+1 : idx+1}.</span> ${it.role}: ${it.text}`;
      if(!showCorrect){
        div.addEventListener('dragstart',e=>{ div.classList.add('dragging'); e.dataTransfer.setData('text/plain', idx); });
        div.addEventListener('dragend',()=>div.classList.remove('dragging'));
      }
      list.appendChild(div);
    });
    if(!showCorrect){
      list.querySelectorAll('.order-item').forEach((el,toIndex)=>{
        el.addEventListener('dragover', e=>{ e.preventDefault(); el.style.boxShadow='0 0 0 3px rgba(43,182,180,.2)'; });
        el.addEventListener('dragleave', ()=>{ el.style.boxShadow=''; });
        el.addEventListener('drop', e=>{
          e.preventDefault(); el.style.boxShadow='';
          const fromIndex=+e.dataTransfer.getData('text/plain');
          const item = orderItems.splice(fromIndex,1)[0]; orderItems.splice(toIndex,0,item);
          renderOrder(false);
        });
      });
    }
  }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  // ===== MODE 4: SPEAK =====
  function setupSpeak(){
    loadState();
    els.speakRole.value = state.speak.role;
    els.saidCnt.textContent = state.speak.said; els.struggledCnt.textContent = state.speak.struggled; els.seeCnt.textContent = state.speak.seen;
    showSpeakPrompt(true);
    els.sSpeak.onclick=()=>{ showSolution(); inc('seen'); };
    els.sSaid.onclick=()=>{ hideSolution(); inc('said'); nextSpeak(); };
    els.sStruggled.onclick=()=>{ hideSolution(); inc('struggled'); nextSpeak(); };
    els.sNext.onclick=()=>{ hideSolution(); nextSpeak(); };
    els.speakRole.onchange=()=>{ state.speak.role=els.speakRole.value; state.speak.idx=0; saveState(); showSpeakPrompt(true); };
    window.onkeydown = ev=>{ if($('#speak').hidden) return; if(ev.key==='Enter'){ els.sNext.click(); } if(ev.key.toLowerCase()==='s'){ els.sSpeak.click(); } };
  }
  function showSpeakPrompt(reset){
    const role = state.speak.role, other = role==='A'?'B':'A'; const turns = topic.turns;
    let idx=state.speak.idx; if(reset) idx=0;
    let found = turns.findIndex((t,i)=> i>=idx && t.speaker===other);
    if(found===-1){ found = turns.findIndex(t=>t.speaker===other); state.speak.idx=0; saveState(); }
    const t=turns[found]; els.speakPrompt.textContent = `${t.speaker}: ${t.text}`;
    els.speakSolution.hidden=true; els.speakSolution.textContent = `${role}: ${nextPartner(found, role)}`;
  }
  function nextPartner(idx, role){
    const turns=topic.turns; for(let i=idx+1;i<turns.length;i++){ if(turns[i].speaker===role) return turns[i].text; } return "(end)";
  }
  function nextSpeak(){ state.speak.idx = Math.min(state.speak.idx+1, topic.turns.length-1); saveState(); showSpeakPrompt(false); }
  function showSolution(){ els.speakSolution.hidden=false; }
  function hideSolution(){ els.speakSolution.hidden=true; }
  function inc(key){ state.speak[key]+=1; saveState(); els.saidCnt.textContent=state.speak.said; els.struggledCnt.textContent=state.speak.struggled; els.seeCnt.textContent=state.speak.seen; }

  // Init UI
  hydrateTopics(); els.startBtn.disabled=false;
})();
</script>
</body>
</html>
